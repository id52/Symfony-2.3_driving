<?php

namespace My\AppBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * PromoKey
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PromoKey extends EntityRepository
{
    public function getBuilderForTriedRezervActiv()
    {
        $qb = $this->createQueryBuilder('pk')
            ->andWhere('pk.source = :source')->setParameter('source', 'campaign')
            ->addOrderBy('pk.created', 'DESC')
            ->leftJoin('pk.tried_enters', 'te')->addSelect('COUNT(DISTINCT te.user) as tried_enter_count')
            ->leftJoin('pk.logs', 'lt', 'WITH', 'lt.paid = :ltp')->setParameter('ltp', true)
            ->addSelect('COUNT(DISTINCT lt.user) as paid_users_count')
            ->leftJoin('pk.logs', 'lf', 'WITH', 'lf.paid = :lfp')->setParameter('lfp', false)
            ->addSelect('COUNT(DISTINCT lf.user) as no_paid_users_count')
            ->addGroupBy('pk.id');

        return $qb;
    }

    public function isRemovable($id)
    {
        $qb = $this->getBuilderForTriedRezervActiv();
        $qb->andWhere('pk.id = :id')->setParameter('id', $id);
        $result = $qb->getQuery()->execute();

        foreach ($result as $value) {
            if ($value['tried_enter_count'] != 0 || $value['paid_users_count'] != 0 ||
                $value['no_paid_users_count'] != 0) {
                return false;
            }
        }
        return true;
    }
}
