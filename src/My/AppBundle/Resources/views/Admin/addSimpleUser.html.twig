{% extends "AppBundle::admin.html.twig" %}

{% block content %}
<h3>{{ 'admin.add_simple_user_title'|trans }}</h3>
<hr>
    {{ form_start(form) }}

    {{ form_errors(form) }}

    <fieldset>
        <legend>{{ 'profile_registr_data'|trans }}:</legend>
        {{ form_row(form.email) }}
        {{ form_row(form.plain_password) }}
        {{ form_row(form.paids) }}
    </fieldset>

    <fieldset>
        <legend>{{ 'profile_registr_data'|trans }}:</legend>
        {{ form_row(form.last_name) }}
        {{ form_row(form.first_name) }}
        {{ form_row(form.patronymic) }}
    </fieldset>



    <fieldset>
        <legend>{{ 'profile_phone_data'|trans }}:</legend>
        <div class="control-group{% if form.phone_mobile.vars.errors|length > 0 %} error{% endif %}">
            {{ form_label(form.phone_mobile) }}
            <div class="controls">
                <div class="input-prepend">
                    <span class="add-on">+7</span>
                    {{ form_widget(form.phone_mobile, { attr: { class: 'span2' }}) }}
                </div>
                {{ form_errors(form.phone_mobile) }}
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>{{ 'profile_additional_info'|trans }}:</legend>
        {{ form_row(form.region) }}
        {{ form_row(form.category) }}
    </fieldset>

    <div class="form-actions">
        <div class="alert alert-info" role="alert" id="pay-amount-info">
        </div>
        <button type="submit" class="btn btn-success"><i class="fa fa-download"></i> {{ 'admin.buttons.create'|trans }}</button>
        {% if user is defined %}
            <a class="btn pull-right" href="{{ path('admin_precheck_user_view', { id: user.id }) }}"><i class="fa fa-arrow-left"></i> {{ 'admin.buttons.back_to_view'|trans }}</a>
        {% endif %}
    </div>
    {{ form_end(form) }}
{% endblock content %}

{% block js %}
<script>
$(function() {
    var phoneMobile = $('#simple_profile_phone_mobile');
    phoneMobile.removeAttr('required');
    phoneMobile.attr('pattern', '\\(\\d{3}\\) \\d{3}-\\d{2}-\\d{2}');
    phoneMobile.inputmask('(999) 999-99-99', { clearMaskOnLostFocus: false, removeMaskOnSubmit:true });

    var regionTree = {{ region_tree|json_encode|raw }};

    var regionElement = $('#simple_profile_region');
    var categoryElement = $('#simple_profile_category');

    var updateCategories = function() {
        var region = regionElement.val();

        $('option', categoryElement).each(function () {
            var isSetProp = Boolean(
                regionTree[region]
                && regionTree[region]['cats'].hasOwnProperty(this.value));
            $(this).toggle(this.value == '' || isSetProp);
        });
    };
    updateCategories();

    regionElement.change(function() {
        categoryElement.val('');
        updateCategories();
    });

    $('#simple_profile_region, #simple_profile_category, #simple_profile_paids').on('change', function() {
        var region_id = regionElement.val();
        var category_id = categoryElement.val();
        var paids = $('#simple_profile_paids').val();
        if (region_id && category_id) {
            var pay_amount_info = $('#pay-amount-info');
            $.ajax({
                type: "GET",
                url: "{{ path('admin_calc_pay_amount') }}",
                data: {
                    region_id: regionElement.val(),
                    category_id: categoryElement.val(),
                    paids: paids
                },
                success: function(data) {
                    pay_amount_info.html('').show();
                    if (typeof(data.categories_price_sum) !== "undefined") {
                        pay_amount_info.append('<div>{{ 'paids.paid_1'|trans }}: '+data.categories_price_sum+'</div>')
                    } else {
                        pay_amount_info.hide();
                    }
                    if (typeof(data.services_price_sum) !== "undefined") {
                        pay_amount_info.append('<div>{{ 'paids.paid_2'|trans }}: '+data.services_price_sum+'</div>')
                    }
                }
            });
        }
    });

});
</script>
{% endblock js %}
