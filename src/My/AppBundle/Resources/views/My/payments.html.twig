{% extends "AppBundle::layout_new.html.twig" %}

{% block content %}
<nav class="path">
    <a href="{{ path('homepage') }}">{{ 'titles.homepage'|trans }}</a>
    » <strong>{{ 'titles.payments'|trans }}</strong>
</nav>

<div class="mainContent">
    {% include 'AppBundle::_owe_stage_paid.html.twig' %}

        <section class="payments">
        <div class="title"><h1>{{ 'titles.payments'|trans }}</h1></div>

        {% if paid_payments %}
        <div class="paid">
            <div class="bg"></div>
            <table>
                <tr>
                    <th>Услуга</th>
                    <th class="w1 center">Дата оплаты</th>
                    <th class="w2 center">Сумма</th>
                    <th class="w3 center">Номер платежа</th>
                </tr>
                {% set categories_payment = null %}
                {% for payment in paid_payments %}
                    {#{% if not is_paid_required or not payment.categories|length %}#}
                        <tr>
                            <td{{ payment.promoKey ? ' rowspan="2"' : '' }} class="first bg-check">
                                {% if payment.categories|length and not payment.driving_name %}
                                    Доступ к полному теоретическому курсу (без «Пакета документов ученика автошколы»)
                                {% endif %}
                                {% if payment.services|length and payment['required'] is defined and not payment.driving_name %}
                                    Доступ к полному теоретическому курсу (с «Пакетом документов ученика автошколы»)
                                {% else %}
                                    {% for service in payment.services %}
                                        {{ service.name }}
                                        {% if not loop.last %}<br>{% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if payment.driving_name %}
                                    {{ payment.driving_name~' '~(payment.driving_primary ? '(первичный пакет вождения)' : '(вторичный пакет вождения)') }}
                                {% endif %}
                                {% if payment.owe_stage %}
                                    Дополнительные административные расходы, связанные с переводом Вас на индивидуальный план обучения
                                {% endif %}
                            </td>
                            <td class="w1 center">
                                {% if categories_payment and is_paid_required and payment['required'] is defined %}
                                    {{ categories_payment.updated_at|localizeddate('long', 'none') }}<br>
                                    {% if categories_payment.promoKey %}<br>{% endif %}
                                {% endif %}
                                {{ payment.updated_at|localizeddate('long', 'none') }}<br>
                                {% if payment.promoKey %}<br>{% endif %}
                            </td>
                            <td class="w2 center">
                                {% if categories_payment and is_paid_required and payment['required'] is defined %}
                                    {{ categories_payment.sum|number_format(0, ',', ' ') }} руб.<br>
                                    {% if categories_payment.promoKey %}
                                        {% if categories_payment.auto_promo is defined %}
                                            <div class="code">Промокод {{ categories_payment.auto_promo|number_format(0, ',', ' ') }} руб.</div>
                                        {% else %}
                                            <div class="code">Промокод {{ categories_payment.promoKey.discount|number_format(0, ',', ' ') }} руб.</div>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                {{ payment.sum|number_format(0, ',', ' ') }} руб.
                                {% if payment.promoKey %}
                                    {% if payment.auto_promo is defined %}
                                        <div class="code">Промокод {{ payment.auto_promo|number_format(0, ',', ' ') }} руб.</div>
                                    {% else %}
                                        <div class="code">Промокод {{ payment.promoKey.discount|number_format(0, ',', ' ') }} руб.</div>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="w3 center {{ (payment.revert ? 'timeleft' : '') }}">
                                {% if categories_payment and is_paid_required and payment['required'] is defined %}
                                    {% if categories_payment.moderator_id is not defined and not payment.revert %}
                                        {{ categories_payment.s_id ? '#'~categories_payment.s_id : ''}}
                                    {% endif %}
                                    {% if categories_payment.promoKey and not payment.revert %}
                                        <br>#{{ categories_payment.promoKey.hash }}
                                    {% endif %}
                                {% endif %}
                                {% if payment.moderator_id is not defined and not payment.revert %}
                                    {{ payment.s_id ? '#'~payment.s_id : ''}}
                                {% endif %}
                                {% if payment.promoKey and not payment.revert %}
                                    <br>#{{ payment.promoKey.hash }}
                                {% endif %}
                                {% if payment.revert %}
                                    <span class="text-error">Платеж отменен</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if not loop.last %}
                        <tr><td colspan="4" class="first"></td></tr>
                        {% endif %}
                    {#{% else %}#}
                        {#{% set categories_payment = payment %}#}
                    {#{% endif %}#}
                {% endfor %}
            </table>
        </div>
        <div class="hr"></div>
        {% endif %}

        {% for payment in payments %}
            {% if payment.required and payment.discount %}
                <figure class="to-pay act">
                    <div class="links">
                        {% if payment.required %}
                            <form id="payments_2" action="{{ path('my_payments_2') }}" method="get">
                                <button class="bg-green pay-link" type="submit">Оплатить</button>
                            </form>
                        {% else %}
                            <form action="" method="post">
                                <input type="hidden" name="ids" value="{{ payment.services|keys|join(',') }}" />
                                <button class="bg-green pay-link" type="submit">Оплатить</button>
                            </form>
                        {% endif %}
                    </div>
                    <div class="price-act">
                        <div class="elem">
                            Полная стоимость:
                            <del>Цена: {{ payment.sum|number_format(0, ',', ' ') }} руб.</del>
                        </div>
                        <div class="elem">
                            Акционное предложение:
                            <strong>Цена: {{ max(payment.sum - payment.discount, 0)|number_format(0, ',', ' ') }} руб.</strong>
                        </div>
                    </div>
                    <div class="nofloat">
                        <div class="cell">
                            Доступ к полному теоретическому курсу (с «Пакетом документов ученика автошколы»)
                        </div>
                    </div>
                    <div class="timer" data-seconds-left="{{ payment.seconds_left ?? 0 }}">
                        <div class="r">
                            Осталось:
                            <div>
                                <span>0 дней</span>
                                <span>0 часов</span>
                                <span>0 минут</span>
                            </div>
                        </div>
                        Акция действует до {{ payment.end_time|date('d.m.Y') }}
                    </div>
                </figure>
            {% elseif payment.required %}
                <figure class="to-pay">
                    <div class="links">
                        <form action="{{ path('my_payments_2') }}" method="get">
                            <button class="bg-green pay-link" type="submit">Оплатить</button>
                        </form>
                    </div>
                    <div class="price">{{ payment.sum|number_format(0, ',', ' ') }} руб.</div>
                    <div class="nofloat">
                        <div class="cell">
                            Доступ к полному теоретическому курсу (с «Пакетом документов ученика автошколы»)
                        </div>
                    </div>
                </figure>
            {% else %}
                <figure class="to-pay">
                    <div class="links">
                        <form action="" method="post">
                            <input type="hidden" name="ids" value="{{ payment.services|keys|join(',') }}" />
                            <button class="bg-green pay-link" type="submit">Оплатить</button>
                        </form>
                    </div>
                    <div class="price">{{ payment.sum|number_format(0, ',', ' ') }} руб.</div>
                    <div class="nofloat">
                        <div class="cell">
                            {% for service in payment.services %}
                                {{ service.name }}
                                {% if not loop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </figure>
            {% endif %}
        {% endfor %}

        {% if user.oweStages|length and user.drivingPaidAt is null %}
            {% if user.drivingPaidAt is null and last_stage.end > date() %}
            <figure class="to-pay act">
                <div class="links">
                    {% if last_stage.end > date() %}
                        <form action="" method="post">
                            <a href="{{ path('my_prepare_owe_paid') }}" class="bg-green pay-link">Оплатить</a>
                        </form>
                    {% endif %}
                </div>
                <div class="price-act">
                    <div class="elem">
                        Оплата в офисе:
                        <del>Цена: {{ settings_notifies['cost_driving_payment_in_office']|raw }} руб.</del>
                    </div>
                    <div class="elem">
                        Оплата онлайн:
                        <strong>Цена: {{ last_stage.sum }} руб.</strong>
                    </div>
                </div>
                <div class="nofloat">
                    <div class="cell">Дополнительные административные расходы, связанные с переводом Вас на индивидуальный план обучения</div>
                </div>
                <div>

                    <div class="timer" data-seconds-left
                    ="{{ last_stage.allSecondsLeft ?? 0 }}">
                        {% if last_stage.end > date() %}
                            {{ (owe_paid_error['message'] is defined ? owe_paid_error['message']~'<br>' : '')  }}
                            <span>Необходимо внести оплату онлайн до: </span>{{ last_stage.end|date('d.m.Y') }}
                            <div class="r" id="owe_timer">
                                Осталось:
                                <div>
                                    <span>0 дней</span>
                                    <span>0 часов</span>
                                    <span>0 минут</span>
                                </div>
                            </div>
                        {% else %}
                            <div class="timeleft">
                                Оплаты по этапу не произведено, для оплаты пройдите в офис.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </figure>
            <div class="hr"></div>
            {% endif %}
            {% if user.drivingPaidAt is null and last_stage.end < date() %}
                <figure class="to-pay act">
                    <div class="links">
                        <form action="" method="post">
                            <div class="btn disabled" disabled="disabled">Оплатить</div>
                        </form>
                    </div>
                    <div class="price-act">
                        <div class="elem">
                            Оплата в офисе:
                            <strong>Цена: {{ settings_notifies['cost_driving_payment_in_office']|raw }} руб.</strong>
                        </div>
                        <div class="elem">
                            Оплата онлайн:
                            <del>Цена: {{ last_stage.sum }} руб.</del>
                        </div>
                    </div>
                    <div class="nofloat">
                        <div class="cell">Доступ к полному теоретическому курсу (с «Пакетом документов ученика автошколы»)</div>
                    </div>
                    <div>
                        <div class="timer">
                            <span>Необходимо внести оплату онлайн до: </span><del>{{ last_stage.end|date('d.m.Y') }}</del>
                            <div class="overdue">
                                Осталось:
                                <div>
                                    <span>0 дней</span>
                                    <span>0 часов</span>
                                    <span>0 минут</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </figure>
                <div class="hr"></div>
            {% endif %}
        {% endif %}

        {% if app.user.region.filialNotExisting and is_granted("ROLE_USER_PAID2") and app.user.finalDocStatus != 'doc_is_picked' %}
            <div class="links">
                <form action="" method="post">
                    <a href="{{ path('my_choce_drive_condition') }}" class="bg-green pay-link">Приобрести пакет вождения</a>
                </form>
            </div>
        {% endif %}
    </section>
</div>
{% endblock content %}

{% block js %}
<script src="/v2/js/jquery.countdown.js"></script>
<script src="/v2/js/jquery.countdown-ru.js"></script>
<script>
    $(function() {
        var timer = $('.timer');
        if (timer.length) {
            $('.r div', timer).each(function() {
                $(this).countdown({
                    until: timer.data('seconds-left'),
                    layout: '{d<}<span>{dn} {dl}</span>{d>}<span>{hn} {hl}</span><span>{mn} {ml}</span>'
                });
            });
        }
    });
</script>
{% endblock js %}
