{% extends "AppBundle::layout_new.html.twig" %}

{% block start_content %}
<div class="modal helper" id="helper">
    {{ settings_notifies['promo_help_btn']|raw }}
    <div class="bottom links">
        <span class="link bg-green check-link btn-close">Спасибо, все понятно</span>
    </div>
    <span class="close"></span>
</div>
{% endblock start_content %}

{% block content %}
<nav class="path">
    <a href="{{ path('homepage') }}">{{ 'titles.homepage'|trans }}</a>
    » <a href="{{ path('my_payments') }}">{{ 'titles.payments'|trans }}</a>
    » {{ 'purchase_of_products'|trans }}
</nav>

<section class="pay">
        <div class="title"><h1>{{ settings_notifies['second_payment_title'] }}</h1></div>

        <div class="wid">
            {{ settings_notifies['second_payment_text']|raw }}

            <div class="hold">
                <h3>пакет ученика автошколы</h3>
                <div class="sum">
                    {% if discount > 0 %}
                        <div class="price">Полная стоимость обучения: <del>Цена: {{ sum|number_format(0, ',', ' ') }} руб.</del></div>
                        <div class="price">Акционное предложение: <strong>Цена: {{ max(sum - discount, 0)|number_format(0, ',', ' ') }} руб.</strong></div>
                    {% else %}
                        <div class="price">Стоимость обучения: <strong>Цена: {{ sum|number_format(0, ',', ' ') }} руб.</strong></div>
                    {% endif %}
                    <div class="code">
                        {# <a href="#helper" class="simplebox">Что такое<br>промокод?</a> #}
                        <div class="input">
                            <input type="hidden" id="initial_sum" value="{{ max(sum - discount, 0) }}" />
                            <input id="promo_input" value="" type="text" placeholder="Введите промокод">
                            <span class="submit"><input id="promo_btn" value="Активировать" type="button"></span>
                        </div>
                    </div>
                </div>
            </div>


            <form action="{{ path('my_payments') }}" method="post">

                <input type="checkbox" name="terms_and_conditions" required="required">
                <label for="terms_and_conditions"><a href="{{ path('my_print_terms_and_conditions_education_service_blank') }}" target="_blank">Я прочитал и согласен с условиями догорова
                        об оказании платных образовательных услуг</a></label><br><br>
                <div class="total">
                    <input id="promo_key" type="hidden" value="" name="promo_key">
                    <input type="hidden" name="ids" value="{{ services|keys|join(',') }}" />
                    Итого: <span id="total_sum">{{ max(sum - discount, 0)|number_format(0, ',', ' ') }}</span> руб.
                    <span class="go">{{ 'buy_products'|trans }} <input value="" type="submit"></span>
                </div>

            </form>




        </div>
</section>
{% endblock content %}

{% block js %}
<script>
$(function() {
    $('#promo_btn').click(function(e) {
        e.preventDefault();

        var key = $('#promo_input').val();
        if (key) {
            $.getJSON('{{ path('check_promo_key') }}', { key: key, type: 'training' }, function(data) {
                if (data.success) {
                    var initSum = parseInt($('#initial_sum').val());
                    var sum = initSum - parseInt(data.discount);
                    sum = Math.max(sum, 0);
                    $('#total_sum').text(sum);
                    $('#promo_key').val(key);
                    var block = $('#promo_btn').closest('.code');
                    block.addClass('success');
                    if (parseInt(data.discount) > initSum) {
                        block.html(data.message+'<strong>'+initSum+' руб.</strong>');
                    } else {
                        block.html(data.message+' <strong>'+data.discount+' руб.</strong>');
                    }
                } else  {
                    js_alert(data.message);
                }
            });
        }
    });

    {% if _server_type == 'prod' %}
    yaCounter1894867.reachGoal('PAYMENT2_ENTER');
    ga('send', 'event', 'Online', 'PAYMENT2_ENTER', '', 0);
    {% endif %}
});
</script>
{% endblock js %}
